// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER MODEL
// Synced with Clerk - stores additional user data
// ========================================
model User {
  id                  String    @id @default(uuid()) @db.Uuid
  clerkId             String    @unique @map("clerk_id")
  email               String    @unique
  firstName           String?   @map("first_name")
  lastName            String?   @map("last_name")
  imageUrl            String?   @map("image_url")
  credits             Int       @default(0)
  isActive            Boolean   @default(true) @map("is_active")
  deletedAt           DateTime? @map("deleted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Localization & Onboarding Metadata
  preferredLanguage   String?   @map("preferred_language") @db.VarChar(10)
  registrationRegion  String?   @map("registration_region") @db.VarChar(10)
  registrationCountry String?   @map("registration_country") @db.VarChar(2)
  initialIp           String?   @map("initial_ip") @db.VarChar(45)
  onboardingComplete  Boolean   @default(false) @map("onboarding_complete")

  // Relations
  interviews    Interview[]
  payments      Payment[]
  signupRecord  SignupRecord?
  scoreHistory  InterviewScoreHistory[]
  usageLogs     UsageLog[]
  chatSessions  ChatSession[]

  @@index([clerkId])
  @@index([email])
  @@index([isActive])
  @@index([preferredLanguage])
  @@index([registrationRegion])
  @@map("users")
}

// ========================================
// SIGNUP RECORD MODEL
// Tracks signup device/IP to prevent free credit abuse
// ========================================
model SignupRecord {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @unique @map("user_id") @db.Uuid
  
  // IP Address tracking
  ipAddress       String?   @map("ip_address")
  
  // Device fingerprint (from FingerprintJS or similar)
  deviceFingerprint String? @map("device_fingerprint")
  
  // Additional device info
  userAgent       String?   @map("user_agent") @db.Text
  
  // Email domain for disposable email detection
  emailDomain     String?   @map("email_domain")
  
  // Whether free credit was granted
  freeCreditGranted Boolean @default(false) @map("free_credit_granted")
  
  // Credit throttling tier: 'full', 'throttled', 'blocked'
  creditTier      String    @default("full") @map("credit_tier")
  
  // Verification status
  phoneVerified   Boolean   @default(false) @map("phone_verified")
  captchaCompleted Boolean  @default(false) @map("captcha_completed")
  linkedInId      String?   @map("linkedin_id")
  
  // Behavioral analysis score (0-100)
  behaviorScore   Int       @default(50) @map("behavior_score")
  
  // Fraud flags
  isSuspicious    Boolean   @default(false) @map("is_suspicious")
  suspicionReason String?   @map("suspicion_reason")
  
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ipAddress])
  @@index([deviceFingerprint])
  @@index([emailDomain])
  @@index([freeCreditGranted])
  @@index([creditTier])
  @@index([phoneVerified])
  @@map("signup_records")
}

// ========================================
// INTERVIEW MODEL
// Stores interview sessions and their results
// ========================================
model Interview {
  id              String           @id @default(uuid()) @db.Uuid
  userId          String           @map("user_id") @db.Uuid
  retellCallId    String?          @unique @map("retell_call_id")
  
  // Interview Details
  jobTitle        String           @map("job_title")
  companyName     String           @map("company_name")
  jobDescription  String           @map("job_description") @db.Text
  
  // Resume stored as base64 or file reference
  resumeData      String?          @map("resume_data") @db.Text
  resumeFileName  String?          @map("resume_file_name")
  resumeMimeType  String?          @map("resume_mime_type")
  
  // Interview Results
  status          InterviewStatus  @default(PENDING)
  score           Float?           @db.DoublePrecision
  
  // Feedback stored as base64 encoded PDF
  feedbackPdf     String?          @map("feedback_pdf") @db.Text
  feedbackText    String?          @map("feedback_text") @db.Text
  
  // Call metrics (from Retell)
  callDuration    Int?             @map("call_duration") // in seconds
  startedAt       DateTime?        @map("started_at")
  endedAt         DateTime?        @map("ended_at")
  
  // Transcript storage for performance chat
  transcript      String?          @db.Text
  
  // Advanced Analytics Fields (populated from Retell call_analysis)
  sentimentScore  Float?           @map("sentiment_score") @db.DoublePrecision // Overall sentiment 0-100
  wpmAverage      Float?           @map("wpm_average") @db.DoublePrecision // Words per minute average
  confidenceTimeline Json?         @map("confidence_timeline") @db.JsonB // Array of {timestamp, value, tone, pace}
  
  // Timestamps
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics         InterviewMetric[]
  scoreHistory    InterviewScoreHistory[]
  transcriptSegments TranscriptSegment[]

  @@index([userId])
  @@index([retellCallId])
  @@index([status])
  @@index([createdAt])
  @@index([jobTitle])
  @@index([companyName])
  @@map("interviews")
}

// ========================================
// INTERVIEW METRICS MODEL
// Stores detailed interview performance metrics
// ========================================
model InterviewMetric {
  id            String    @id @default(uuid()) @db.Uuid
  interviewId   String    @map("interview_id") @db.Uuid
  
  // Metric categories
  category      String    // e.g., "communication", "technical", "behavioral"
  metricName    String    @map("metric_name")
  score         Float     @db.DoublePrecision
  maxScore      Float     @default(10) @map("max_score") @db.DoublePrecision
  feedback      String?   @db.Text
  
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
  @@index([category])
  @@map("interview_metrics")
}

// ========================================
// TRANSCRIPT SEGMENT MODEL
// Stores timestamped transcript segments for media sync
// ========================================
model TranscriptSegment {
  id            String    @id @default(uuid()) @db.Uuid
  interviewId   String    @map("interview_id") @db.Uuid
  
  // Segment content
  speaker       String    // 'agent' or 'user'
  content       String    @db.Text
  
  // Time markers for audio/video sync (in seconds)
  startTime     Float     @map("start_time") @db.DoublePrecision
  endTime       Float     @map("end_time") @db.DoublePrecision
  
  // Segment-level analytics
  sentimentScore Float?   @map("sentiment_score") @db.DoublePrecision
  
  // Ordering
  segmentIndex  Int       @map("segment_index")
  
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
  @@index([startTime])
  @@index([segmentIndex])
  @@map("transcript_segments")
}

// ========================================
// ROLE PERFORMANCE BENCHMARK MODEL
// Stores aggregated performance metrics per role for comparative analysis
// ========================================
model RolePerformanceBenchmark {
  id                  String    @id @default(uuid()) @db.Uuid
  
  // Role identification (normalized job title)
  roleTitle           String    @unique @map("role_title")
  
  // Aggregated metrics
  globalAverageScore  Float     @map("global_average_score") @db.DoublePrecision
  totalInterviews     Int       @map("total_interviews")
  
  // Score distribution for percentile calculation
  scoreDistribution   Json      @map("score_distribution") @db.JsonB // {buckets: [{min, max, count}]}
  
  // Soft skills averages
  avgCommunication    Float?    @map("avg_communication") @db.DoublePrecision
  avgProblemSolving   Float?    @map("avg_problem_solving") @db.DoublePrecision
  avgTechnicalDepth   Float?    @map("avg_technical_depth") @db.DoublePrecision
  avgLeadership       Float?    @map("avg_leadership") @db.DoublePrecision
  avgAdaptability     Float?    @map("avg_adaptability") @db.DoublePrecision
  
  // Metadata
  lastCalculatedAt    DateTime  @map("last_calculated_at") @default(now())
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([roleTitle])
  @@index([lastCalculatedAt])
  @@map("role_performance_benchmarks")
}

// ========================================
// AI STUDY RECOMMENDATIONS MODEL
// Stores AI-generated learning recommendations per interview
// ========================================
model StudyRecommendation {
  id            String    @id @default(uuid()) @db.Uuid
  interviewId   String    @unique @map("interview_id") @db.Uuid
  
  // Recommendation data
  topics        Json      @db.JsonB // [{topic, priority, reason, resources}]
  weakAreas     Json      @map("weak_areas") @db.JsonB // [{area, score, suggestion}]
  
  // Metadata
  generatedAt   DateTime  @default(now()) @map("generated_at")
  
  @@index([interviewId])
  @@map("study_recommendations")
}

// ========================================
// PAYMENT MODEL
// Stores payment transaction records
// ========================================
model Payment {
  id                  String        @id @default(uuid()) @db.Uuid
  userId              String        @map("user_id") @db.Uuid
  
  // MercadoPago identifiers
  mercadoPagoId       String?       @unique @map("mercadopago_id")
  preferenceId        String?       @map("preference_id")
  
  // Package details
  packageId           String        @map("package_id")
  packageName         String        @map("package_name")
  creditsAmount       Int           @map("credits_amount")
  
  // Payment amounts
  amountUSD           Float         @map("amount_usd") @db.DoublePrecision
  amountBRL           Float         @map("amount_brl") @db.DoublePrecision
  
  // Payment status
  status              PaymentStatus @default(PENDING)
  statusDetail        String?       @map("status_detail")
  
  // Timestamps
  paidAt              DateTime?     @map("paid_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadoPagoId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ========================================
// INTERVIEW SCORE HISTORY MODEL
// Historical score tracking by role and company for analytics
// ========================================
model InterviewScoreHistory {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  interviewId   String    @map("interview_id") @db.Uuid
  
  // Role and company for filtering/aggregation
  role          String    // Normalized job title/role
  company       String    // Company name
  
  // Scores
  overallScore  Float     @map("overall_score") @db.DoublePrecision
  technicalScore Float?   @map("technical_score") @db.DoublePrecision
  communicationScore Float? @map("communication_score") @db.DoublePrecision
  confidenceScore Float?  @map("confidence_score") @db.DoublePrecision
  
  // Metadata
  callDuration  Int?      @map("call_duration") // in seconds
  
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([userId, role])
  @@index([userId, company])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([role])
  @@map("interview_score_history")
}

// ========================================
// USAGE LOG MODEL
// Tracks user activity for analytics and monitoring
// ========================================
model UsageLog {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  
  // Event type: 'interview_started', 'interview_completed', 'credits_purchased', etc.
  eventType   String    @map("event_type")
  
  // Flexible event data
  eventData   Json?     @map("event_data") @db.JsonB
  
  // For quick time-series queries
  timestamp   DateTime  @default(now())
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([eventType, timestamp])
  @@index([timestamp])
  @@map("usage_logs")
}

// ========================================
// DISPOSABLE EMAIL DOMAIN MODEL
// Blocklist for temporary/disposable email providers
// ========================================
model DisposableEmailDomain {
  id        String    @id @default(uuid()) @db.Uuid
  domain    String    @unique
  source    String?   // Where this domain was sourced from
  isActive  Boolean   @default(true) @map("is_active")
  addedAt   DateTime  @default(now()) @map("added_at")

  @@index([domain])
  @@index([isActive])
  @@map("disposable_email_domains")
}

// ========================================
// SUBNET TRACKER MODEL
// Tracks signup velocity from IP subnets for abuse detection
// ========================================
model SubnetTracker {
  id            String    @id @default(uuid()) @db.Uuid
  subnet        String    // /24 subnet (e.g., "192.168.1.0/24")
  signupCount   Int       @default(1) @map("signup_count")
  lastSignupAt  DateTime  @default(now()) @map("last_signup_at")
  windowStart   DateTime  @default(now()) @map("window_start")
  
  // Automatic cleanup after 24 hours
  expiresAt     DateTime  @map("expires_at")

  @@unique([subnet, windowStart])
  @@index([subnet])
  @@index([windowStart])
  @@index([expiresAt])
  @@map("subnet_trackers")
}

// ========================================
// PERFORMANCE CHAT SESSION MODEL
// Stores chat history for performance analyst conversations
// ========================================
model ChatSession {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  
  // Chat context filters
  roleFilter  String?   @map("role_filter")
  companyFilter String? @map("company_filter")
  
  // Session state
  isActive    Boolean   @default(true) @map("is_active")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@index([userId])
  @@index([isActive])
  @@map("chat_sessions")
}

// ========================================
// CHAT MESSAGE MODEL
// Individual messages in a chat session
// ========================================
model ChatMessage {
  id          String    @id @default(uuid()) @db.Uuid
  sessionId   String    @map("session_id") @db.Uuid
  
  // Message content
  role        String    // 'user' or 'assistant'
  content     String    @db.Text
  
  // Optional metadata
  metadata    Json?     @db.JsonB
  
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ========================================
// ENUMS
// ========================================

enum InterviewStatus {
  PENDING     // Interview created but not started
  IN_PROGRESS // Interview currently in progress
  COMPLETED   // Interview completed successfully
  FAILED      // Interview failed (technical error)
  CANCELLED   // Interview cancelled by user
}

enum PaymentStatus {
  PENDING     // Payment initiated
  APPROVED    // Payment successful
  REJECTED    // Payment rejected
  CANCELLED   // Payment cancelled
  REFUNDED    // Payment refunded
  IN_PROCESS  // Payment being processed
}
